CREATE OR REPLACE VIEW V_RENRAKU AS
SELECT
    RENRAKU_MAIN.KANRI_NO,
    RENRAKU_MAIN.TENCHAKU_YMD,
    RENRAKU_MAIN.HASSHIN_BUSHO_CD,
    RENRAKU_MAIN.HASSHIN_BUSHO_NM,
    RENRAKU_MAIN.HASSHIN_BUSHO_NM_ALL,
    RENRAKU_MAIN.HASSHIN_SHAIN_NM,
    RENRAKU_MAIN.DENGONBAN_FLG,
    RENRAKU_MAIN.HOKOKU_FLG,
    RENRAKU_MAIN.BUNSHO_KBN,
    RENRAKU_MAIN.ATESAKI_KBN,
    RENRAKU_MAIN.HINBAN,
    RENRAKU_MAIN.SHUDAI_CD,
    RENRAKU_MAIN.KENMEI,
    RENRAKU_MAIN.RENRAKUBUN,
    RENRAKU_MAIN.TENPO_SAGYO,
    RENRAKU_MAIN.TEJUN,
    RENRAKU_MAIN.SONOTA_RENRAKU,
    RENRAKU_MAIN.HENSHIN_YOFU_FLG,
    RENRAKU_MAIN.HENSHIN_KIGEN_YMD,
    RENRAKU_MAIN.HENSHIN_HOHO_CD,
    RENRAKU_MAIN.TANAWARI_YOFU_FLG,
    RENRAKU_MAIN.SAGYO_FROM_YMD,
    RENRAKU_MAIN.SAGYO_TO_YMD,
    RENRAKU_MAIN.TENPU_FILE_FLG,
    RENRAKU_MAIN.RENRAKU_KBN,
    RENRAKU_MAIN.KINKYU_HASSHIN_FLG,
    RENRAKU_MAIN.SAKUSEI_SHAIN_CD,
    RENRAKU_MAIN.SHONIN_FLG,
    RENRAKU_MAIN.SHONIN_SHAIN_CD,
    RENRAKU_MAIN.DEL_FLG
    , syokui_nm.nm as DISP_TAISHO
    , syokui_cd.cd as TAISHO_CD_LIST
    , line_nm.nm as DISP_ATESAKI
    , line_cd.cd as ATESAKI_CD_LIST
FROM
    T_RENRAKU RENRAKU_MAIN
LEFT OUTER JOIN
    (
        select kbn.KANRI_NO, GROUP_CONCAT(kbn.CR_ATESAKI_CD) as cd
        from 
        (SELECT TATSK.KANRI_NO, TATSK.TAISHO_KBN, VATSK.CR_ATESAKI_CD
          FROM
              T_ATESAKI_CD TATSK
          INNER JOIN
              V_ATESAKI VATSK
          ON CONCAT(TATSK.C_ATESAKI_CD,TATSK.R_ATESAKI_CD) = VATSK.CR_ATESAKI_CD
          ORDER BY TATSK.KANRI_NO, VATSK.R_SORT, VATSK.C_SORT, VATSK.CR_ATESAKI_CD
        ) kbn
        where kbn.TAISHO_KBN = '0'
        group by kbn.KANRI_NO
    ) syokui_cd
      on RENRAKU_MAIN.KANRI_NO = syokui_cd.KANRI_NO
LEFT OUTER JOIN
    (
        select kbn.KANRI_NO, GROUP_CONCAT(kbn.CR_ATESAKI_NM) as nm
        from 
        (SELECT TATSK.KANRI_NO, TATSK.TAISHO_KBN, VATSK.CR_ATESAKI_NM
          FROM
              T_ATESAKI_CD TATSK
          INNER JOIN
              V_ATESAKI VATSK
          ON CONCAT(TATSK.C_ATESAKI_CD,TATSK.R_ATESAKI_CD) = VATSK.CR_ATESAKI_CD
          ORDER BY TATSK.KANRI_NO, VATSK.R_SORT, VATSK.C_SORT, VATSK.CR_ATESAKI_CD
        ) kbn
        where  kbn.TAISHO_KBN = '0'
        group by kbn.KANRI_NO
    ) syokui_nm
     on RENRAKU_MAIN.KANRI_NO = syokui_nm.KANRI_NO
LEFT OUTER JOIN
    (
        select kbn.KANRI_NO, GROUP_CONCAT(kbn.CR_ATESAKI_CD) as cd
        from 
        (SELECT TATSK.KANRI_NO, TATSK.TAISHO_KBN, VATSK.CR_ATESAKI_CD
          FROM
              T_ATESAKI_CD TATSK
          INNER JOIN
              V_ATESAKI VATSK
          ON CONCAT(TATSK.C_ATESAKI_CD,TATSK.R_ATESAKI_CD) = VATSK.CR_ATESAKI_CD
          ORDER BY TATSK.KANRI_NO, VATSK.R_SORT, VATSK.C_SORT, VATSK.CR_ATESAKI_CD
        ) kbn
        where kbn.TAISHO_KBN = '1'
        group by kbn.KANRI_NO
    ) line_cd
      on RENRAKU_MAIN.KANRI_NO = line_cd.KANRI_NO  
LEFT OUTER JOIN
    (
        select kbn.KANRI_NO, GROUP_CONCAT(kbn.CR_ATESAKI_NM) as nm
        from 
        (SELECT TATSK.KANRI_NO, TATSK.TAISHO_KBN, VATSK.CR_ATESAKI_NM
          FROM
              T_ATESAKI_CD TATSK
          INNER JOIN
              V_ATESAKI VATSK
          ON CONCAT(TATSK.C_ATESAKI_CD,TATSK.R_ATESAKI_CD) = VATSK.CR_ATESAKI_CD
          ORDER BY TATSK.KANRI_NO, VATSK.R_SORT, VATSK.C_SORT, VATSK.CR_ATESAKI_CD
        ) kbn
        where  kbn.TAISHO_KBN = '1'
        group by kbn.KANRI_NO
    ) line_nm
     on RENRAKU_MAIN.KANRI_NO = line_nm.KANRI_NO